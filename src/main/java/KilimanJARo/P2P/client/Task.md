### Задачи сервера клиента
- Обработка запросов от сервера 
  - Запрос на прокладку туннеля MakeTube(from, to, tunnel_id) [from - IP:port на котором ждут TCP соединения. to - IP от которого мы ждем соединение. В случае null аргументов, второй конец прокладывается на локальный порт.]
    - Ответ (is_allowed, port) [port - порт на котором ожидается соединения от следующего элемента цепочки]
  - Запрос на закрытие туннеля CloseTube(tunnel_id)
    - NO RESPONSE
  - Запрос на установку соединения RequestConnection(request_user, tunnel_id) [Перенаправляется на фронт]
    - Ответ (is_allowed, reason, tunnel_id)
  - Запрос на финализацию установки соединения EstablishConnection(tunnel_id, local_id, endpoint_user) [Перенаправляется на фронт, обогащаясь портом, на который развернут туннель]
    - NO RESPONSE
  - Запрос на регистрацию RegisterWithMainServer()
    - Ответ (is_success, message, password)
  - Запрос на аутентификацию AuthWithMainServer(password)
    - Ответ (is_success, message, next_password)
  - Запрос на выход LogoutFromMainServer()
    - Ответ (is_success, message)

- Обработка запросов от локального пользователя
  - Запрос на создание тонеля RequestTube(endpoint_name, local_id) [Перенаправляется на сервер]
    - Ответ перенаправляется с сервера
  - Запрос на закрытие тонеля RequestCloseTube(local_id) [Перенаправляется на сервер обогащаясь tunnel_id]

  

### Порядок открытия TCP тоннеля
- Начиная с нулевой ноды (той что запрашивала тоннель)
- Будем считать что цепь туннелей ориентированна от пользователя который запросил соединение к пользователю который его приянл.
- У каждой ноды есть 2 соединения:
  - Входное
  - Выходное
  - Ориентация условна, итоговый тоннель двунаправленный.
  - Будем это использовать для упрощения поясмнения.

- Приходит запрос MakeTube(null, "SOMEIP", tunnel_id) на нулевую ноду
  - Кидаем запрос на фронт чтобы он начал слушать некоторый порт и вернул его нам.
  - Устанавливаем соединение с этим портом.
  - Если не удалось установить соединение мы возвращаем ошибку на сервер.
  - Находим свободный порт.
    - Начинаем асинхронно его прослушивать в ожидании соединения.
    - Как только приходит соединение, проверям его IP на совпадение с SOMEIP, и в случае совпадения устанавливаем соединение.
    - Асинхронный поток переходит в режим проброски данных между входным и выходным соединением.
  - Возвращаем на центральный сервер успих и адрес порта на котором мы зарезрвировали соединение.

- Приходит запрос MakeTube("SOMEIP&PORT", "SOMEIP", tunnel_id) на первую ноду
  - Устанавливаем соединение с пользователем SOMEIP&PORT по порту и IP указанным в аргументе.
  - Если не удалось установить соединение мы возвращаем ошибку на сервер.
  - Находим свободный порт.
    - Начинаем асинхронно его прослушивать в ожидании соединения. Эта часть выполняется асинхронно и от нее уже не зависит ответ на MakeTube.
    - Как только приходит соединение, проверям его IP на совпадение с SOMEIP, и в случае совпадения устанавливаем соединение.
    - Асинхронный поток переходит в режим проброски данных между входным и выходным соединением.
  - Возвращаем на центральный сервер успих и адрес порта на котором мы зарезрвировали соединение.
... то-же самое по очереди для всех нод кроме последней

- Приходит запрос MakeTube("SOMEIP&PORT", null, tunnel_id) на последнюю ноду
  - Устанавливаем соединение с пользователем SOMEIP&PORT по порту и IP указанным в аргументе.
  - Если не удалось установить соединение мы возвращаем ошибку на сервер.
  - Находим свободный порт.
    - Начинаем асинхронно его прослушивать в ожидании соединения. Эта часть выполняется асинхронно и от нее уже не зависит ответ на MakeTube.
    - Кидаем на фронт запрос на связывание тоннеля по tunnel_id.
    - Как только приходит соединение, асинхронный поток переходит в режим проброски данных между входным и выходным соединением.
  - Возвращаем на центральный сервер успих.